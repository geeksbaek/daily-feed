name: FCM Issue Processor

on:
  issues:
    types: [opened, labeled]

jobs:
  process-fcm-request:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'fcm-subscribe') || contains(github.event.issue.labels.*.name, 'fcm-unsubscribe')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
          cache: true

      - name: Parse FCM request from issue
        id: parse-request
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            const labels = context.payload.issue.labels.map(l => l.name);
            
            // í† í°ê³¼ í† í”½ ì¶”ì¶œ
            const tokenMatch = issueBody.match(/- \*\*í† í°\*\*: `([^`]+)`/);
            const topicMatch = issueBody.match(/- \*\*í† í”½\*\*: `([^`]+)`/);
            
            if (!tokenMatch || !topicMatch) {
              core.setFailed('ì´ìŠˆì—ì„œ í† í° ë˜ëŠ” í† í”½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            const token = tokenMatch[1];
            const topic = topicMatch[1];
            const isUnsubscribe = labels.includes('fcm-unsubscribe');
            
            core.setOutput('token', token);
            core.setOutput('topic', topic);
            core.setOutput('action', isUnsubscribe ? 'unsubscribe' : 'subscribe');
            
            console.log(`FCM ìš”ì²­ íŒŒì‹± ì™„ë£Œ: ${isUnsubscribe ? 'êµ¬ë… í•´ì œ' : 'êµ¬ë…'} - í† í”½: ${topic}`);

      - name: Execute FCM subscription
        if: steps.parse-request.outputs.action == 'subscribe'
        working-directory: backend
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "ğŸ“± í† í”½ '${{ steps.parse-request.outputs.topic }}'ì— êµ¬ë… ì¤‘..."
          go run cmd/fcm-subscribe/main.go \
            --token "${{ steps.parse-request.outputs.token }}" \
            --topic "${{ steps.parse-request.outputs.topic }}"
          echo "âœ… êµ¬ë… ì™„ë£Œ!"

      - name: Execute FCM unsubscription
        if: steps.parse-request.outputs.action == 'unsubscribe'
        working-directory: backend
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "ğŸ“± í† í”½ '${{ steps.parse-request.outputs.topic }}'ì—ì„œ êµ¬ë… í•´ì œ ì¤‘..."
          go run cmd/fcm-subscribe/main.go \
            --token "${{ steps.parse-request.outputs.token }}" \
            --topic "${{ steps.parse-request.outputs.topic }}" \
            --unsubscribe
          echo "âœ… êµ¬ë… í•´ì œ ì™„ë£Œ!"

      - name: Comment on issue with result
        uses: actions/github-script@v7
        with:
          script: |
            const action = '${{ steps.parse-request.outputs.action }}';
            const topic = '${{ steps.parse-request.outputs.topic }}';
            const actionText = action === 'unsubscribe' ? 'êµ¬ë… í•´ì œ' : 'êµ¬ë…';
            const emoji = action === 'unsubscribe' ? 'ğŸ”•' : 'ğŸ””';
            
            const comment = `${emoji} **FCM ${actionText} ì™„ë£Œ**
            
í† í”½ \`${topic}\`ì— ëŒ€í•œ ${actionText}ì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.

- ì²˜ë¦¬ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}
- GitHub Actions Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

${action === 'subscribe' ? 'ì´ì œ ìƒˆë¡œìš´ Daily Feed ì—…ë°ì´íŠ¸ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!' : 'ë” ì´ìƒ ì•Œë¦¼ì„ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.'}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Close and label issue
        uses: actions/github-script@v7
        with:
          script: |
            const action = '${{ steps.parse-request.outputs.action }}';
            const completedLabel = action === 'unsubscribe' ? 'fcm-unsubscribed' : 'fcm-subscribed';
            
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              labels: [completedLabel, 'auto-processed']
            });

      - name: Handle error
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `âŒ **FCM ìš”ì²­ ì²˜ë¦¬ ì‹¤íŒ¨**
            
ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

- ì‹¤íŒ¨ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}
- GitHub Actions Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ìˆ˜ë™ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

\`\`\`bash
gh workflow run "FCM Auto Subscribe" -f action="${{ steps.parse-request.outputs.action }}" -f token="${{ steps.parse-request.outputs.token }}" -f topic="${{ steps.parse-request.outputs.topic }}"
\`\`\``;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['fcm-error']
            });
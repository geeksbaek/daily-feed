name: FCM Push Notification

on:
  # ìˆ˜ë™ ì‹¤í–‰ (ë§¤ê°œë³€ìˆ˜ ì§€ì›)
  workflow_dispatch:
    inputs:
      title:
        description: 'ì•Œë¦¼ ì œëª©'
        required: false
        default: 'Daily Feed'
        type: string
      body:
        description: 'ì•Œë¦¼ ë‚´ìš©'
        required: false
        default: 'ìƒˆë¡œìš´ ê¸°ìˆ  ë‰´ìŠ¤ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!'
        type: string
      date:
        description: 'ë‚ ì§œ (YYYY-MM-DD)'
        required: false
        default: ''
        type: string
      topic:
        description: 'í† í”½ (all_users ê¸°ë³¸ê°’)'
        required: false
        default: 'all_users'
        type: string
      test_token:
        description: 'í…ŒìŠ¤íŠ¸ìš© ê°œë³„ í† í° (í† í”½ ëŒ€ì‹  ì‚¬ìš©)'
        required: false
        default: ''
        type: string

  # ë‹¤ë¥¸ workflowì—ì„œ í˜¸ì¶œ ê°€ëŠ¥
  workflow_call:
    inputs:
      title:
        description: 'ì•Œë¦¼ ì œëª©'
        required: false
        default: 'Daily Feed'
        type: string
      body:
        description: 'ì•Œë¦¼ ë‚´ìš©'
        required: false
        default: 'ìƒˆë¡œìš´ ê¸°ìˆ  ë‰´ìŠ¤ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!'
        type: string
      date:
        description: 'ë‚ ì§œ (YYYY-MM-DD)'
        required: false
        default: ''
        type: string
      topic:
        description: 'í† í”½'
        required: false
        default: 'all_users'
        type: string

permissions:
  contents: read

jobs:
  send-fcm-notification:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set default date
        id: date
        run: |
          if [ -z "${{ inputs.date }}" ]; then
            echo "date=$(TZ='Asia/Seoul' date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          else
            echo "date=${{ inputs.date }}" >> $GITHUB_OUTPUT
          fi

      - name: Send FCM notification to topic
        if: ${{ inputs.test_token == '' }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        working-directory: ./backend
        run: |
          echo "ğŸ“± í† í”½ '${{ inputs.topic }}'ë¡œ FCM ì•Œë¦¼ ë°œì†¡ ì¤‘..."
          go run cmd/fcm-send/main.go \
            --topic "${{ inputs.topic }}" \
            --title "${{ inputs.title }}" \
            --body "${{ inputs.body }}" \
            --date "${{ steps.date.outputs.date }}"

      - name: Send FCM notification to test token
        if: ${{ inputs.test_token != '' }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        working-directory: ./backend
        run: |
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ í† í°ìœ¼ë¡œ FCM ì•Œë¦¼ ë°œì†¡ ì¤‘..."
          go run cmd/fcm-send/main.go \
            --token "${{ inputs.test_token }}" \
            --title "${{ inputs.title }}" \
            --body "${{ inputs.body }}" \
            --date "${{ steps.date.outputs.date }}"

      - name: Notification sent
        run: |
          echo "âœ… FCM ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ!"
          echo "ğŸ“‹ ë°œì†¡ ì •ë³´:"
          echo "  - ì œëª©: ${{ inputs.title }}"
          echo "  - ë‚´ìš©: ${{ inputs.body }}"
          echo "  - ë‚ ì§œ: ${{ steps.date.outputs.date }}"
          if [ -n "${{ inputs.test_token }}" ]; then
            echo "  - í…ŒìŠ¤íŠ¸ í† í°ìœ¼ë¡œ ë°œì†¡"
          else
            echo "  - í† í”½: ${{ inputs.topic }}"
          fi
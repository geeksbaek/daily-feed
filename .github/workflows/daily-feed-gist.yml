name: Daily Feed to Gist

on:
  schedule:
    - cron: '0 22 * * *'  # 매일 오전 7시 KST (UTC 22:00)
  workflow_dispatch:  # 수동 실행 가능

jobs:
  create-daily-feed-gist:
    runs-on: "kakao-runner"
    env:
      HTTP_PROXY: ${{ secrets.HTTP_PROXY }}
      HTTPS_PROXY: ${{ secrets.HTTPS_PROXY }}
      NO_PROXY: ${{ secrets.NO_PROXY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GOPROXY: "https://proxy.golang.org,direct"
      GOSUMDB: "sum.golang.org"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version-file: go.mod
    
    - name: Build daily-feed
      run: |
        go env -w GOPROXY=https://proxy.golang.org,direct
        go env -w GOSUMDB=sum.golang.org
        go build -o daily-feed .
    
    - name: Generate daily feed and create gist
      run: |
        # daily-feed 실행하여 출력을 변수로 저장
        FEED_OUTPUT=$(./daily-feed)
        
        # 현재 날짜 생성
        DATE=$(date +%Y-%m-%d)
        
        # Gist 생성
        curl -X POST \
          -H "Authorization: token ${{ secrets.BEANS_GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Content-Type: application/json" \
          https://github.daumkakao.com/api/v3/gists \
          -d "{
            \"description\": \"Daily Feed - $DATE\",
            \"public\": false,
            \"files\": {
              \"daily-feed-$DATE.md\": {
                \"content\": $(echo "$FEED_OUTPUT" | jq -Rs .)
              }
            }
          }"
    
